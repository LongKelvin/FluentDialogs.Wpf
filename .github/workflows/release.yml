# ──────────────────────────────────────────────────────────────
# CD — Stage 1: Build & Draft GitHub Release
#
# Creates a DRAFT GitHub Release with auto-generated release notes
# and attached build artifacts. The owner then:
#   1. Reviews and edits the release notes on GitHub
#   2. Clicks "Publish release"
#   3. → publish-nuget.yml fires automatically
#
# Triggers:
#   1. AUTOMATIC — push a tag like v2.1.0
#      git tag v2.1.0 && git push origin v2.1.0
#
#   2. MANUAL — Actions tab → "Release" → Run workflow
#      Enter version (e.g. "2.1.0"), optionally mark as prerelease.
# ──────────────────────────────────────────────────────────────
name: Release

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:
    inputs:
      version:
        description: "Package version (e.g. 2.1.0 — without 'v' prefix)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release?"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  DOTNET_VERSION: "9.0.x"
  CONFIGURATION: Release

jobs:
  build-and-draft:
    name: Build, Pack & Draft Release
    runs-on: windows-latest

    steps:
      # ── Checkout ──────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # ── Resolve version ───────────────────────────────────
      - name: Determine version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $ver = "${{ inputs.version }}"
          } else {
            $ver = "${{ github.ref_name }}" -replace '^v', ''
          }
          if (-not $ver) { throw "Version could not be determined" }
          Write-Host "Version: $ver"
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT
          echo "TAG=v$ver"    >> $env:GITHUB_OUTPUT

      # ── Patch version in csproj ───────────────────────────
      - name: Update csproj version
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.VERSION }}"
          $file = "FluentDialogs.Wpf.csproj"
          $content = Get-Content $file -Raw
          $content = $content -replace '<Version>[^<]+</Version>', "<Version>$ver</Version>"
          Set-Content $file $content -NoNewline
          Write-Host "Patched $file → $ver"

      # ── Build & Pack ──────────────────────────────────────
      - name: Restore
        run: dotnet restore FluentDialogs.Wpf.csproj

      - name: Build
        run: dotnet build FluentDialogs.Wpf.csproj -c ${{ env.CONFIGURATION }} --no-restore /p:Version=${{ steps.version.outputs.VERSION }}

      - name: Pack
        run: dotnet pack FluentDialogs.Wpf.csproj -c ${{ env.CONFIGURATION }} --no-build -o artifacts /p:Version=${{ steps.version.outputs.VERSION }}

      - name: Create release zip
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.VERSION }}"
          Compress-Archive -Path "artifacts\*.nupkg","artifacts\*.snupkg" `
            -DestinationPath "artifacts\FluentDialogs.Wpf.$ver.zip"

      # ── Generate release notes ────────────────────────────
      - name: Generate release notes
        shell: pwsh
        run: |
          $ver  = "${{ steps.version.outputs.VERSION }}"
          $tag  = "${{ steps.version.outputs.TAG }}"

          # Find previous tag
          $prevTag = git tag --sort=-creatordate | Where-Object { $_ -ne $tag } | Select-Object -First 1
          if (-not $prevTag) { $prevTag = (git rev-list --max-parents=0 HEAD | Select-Object -First 1) }

          # Collect commits since previous tag
          $commits = git log "$prevTag..$tag" --pretty=format:"- %s (%h)" 2>$null
          if (-not $commits) {
            $commits = git log "$prevTag..HEAD" --pretty=format:"- %s (%h)" 2>$null
          }

          # Categorize commits by conventional-commit prefix
          $features    = @()
          $fixes       = @()
          $chores      = @()
          $breaking    = @()
          $other       = @()

          foreach ($line in ($commits -split "`n")) {
            if (-not $line) { continue }
            if ($line -match 'BREAKING|breaking') { $breaking += $line }
            elseif ($line -match '^\- feat')      { $features += $line }
            elseif ($line -match '^\- fix')       { $fixes    += $line }
            elseif ($line -match '^\- (ci|chore|build|docs|style|refactor|perf|test)') { $chores += $line }
            else                                  { $other    += $line }
          }

          # Build release notes markdown
          $notes = @()
          $notes += "# FluentDialogs.Wpf v$ver"
          $notes += ""
          $notes += "## Highlights"
          $notes += ""
          $notes += "<!-- EDIT THIS — Write 3-5 bullet points about the key changes -->"
          $notes += "<!-- Then delete these HTML comments before publishing       -->"
          $notes += ""

          if ($breaking.Count -gt 0) {
            $notes += "## Breaking Changes"
            $notes += ""
            $breaking | ForEach-Object { $notes += $_ }
            $notes += ""
          }

          if ($features.Count -gt 0) {
            $notes += "## New Features"
            $notes += ""
            $features | ForEach-Object { $notes += $_ }
            $notes += ""
          }

          if ($fixes.Count -gt 0) {
            $notes += "## Bug Fixes"
            $notes += ""
            $fixes | ForEach-Object { $notes += $_ }
            $notes += ""
          }

          if ($chores.Count -gt 0) {
            $notes += "## Maintenance"
            $notes += ""
            $chores | ForEach-Object { $notes += $_ }
            $notes += ""
          }

          if ($other.Count -gt 0) {
            $notes += "## Other Changes"
            $notes += ""
            $other | ForEach-Object { $notes += $_ }
            $notes += ""
          }

          $notes += "## Compatibility"
          $notes += ""
          $notes += "<!-- EDIT THIS — e.g. 'Fully backward compatible with v1.x' or list breaking changes -->"
          $notes += ""

          $notes += "## Install"
          $notes += ""
          $notes += '```'
          $notes += "dotnet add package FluentDialogs.Wpf --version $ver"
          $notes += '```'
          $notes += ""
          $notes += "Or install from a .nupkg file:"
          $notes += '```'
          $notes += 'dotnet nuget add source <FOLDER_CONTAINING_NUPKG> -n LocalPackages'
          $notes += 'dotnet add package FluentDialogs.Wpf --source LocalPackages'
          $notes += '```'
          $notes += ""

          if ($prevTag -and ($prevTag -match '^v')) {
            $notes += "## Full Changelog"
            $notes += "https://github.com/${{ github.repository }}/compare/$prevTag...$tag"
            $notes += ""
          }

          $content = $notes -join "`n"
          $content | Out-File -FilePath "release-notes.md" -Encoding utf8
          Write-Host "--- Generated Release Notes ---"
          Write-Host $content

      # ── Create DRAFT GitHub Release ───────────────────────
      - name: Create or push tag (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $tag = "${{ steps.version.outputs.TAG }}"
          git tag $tag 2>$null
          git push origin $tag 2>$null

      - name: Create DRAFT GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.VERSION }}"
          $tag = "${{ steps.version.outputs.TAG }}"
          $pre = ""
          if ("${{ inputs.prerelease }}" -eq "true") { $pre = "--prerelease" }

          $args = @(
            "release", "create", $tag,
            "artifacts/FluentDialogs.Wpf.$ver.nupkg",
            "artifacts/FluentDialogs.Wpf.$ver.snupkg",
            "artifacts/FluentDialogs.Wpf.$ver.zip",
            "--title", "FluentDialogs.Wpf v$ver",
            "--notes-file", "release-notes.md",
            "--draft"
          )
          if ($pre) { $args += $pre }

          & gh @args

          Write-Host ""
          Write-Host "=================================================="
          Write-Host "  DRAFT release created for v$ver!"
          Write-Host ""
          Write-Host "  Next steps:"
          Write-Host "  1. Go to: https://github.com/${{ github.repository }}/releases"
          Write-Host "  2. Edit the draft release notes"
          Write-Host "  3. Click 'Publish release'"
          Write-Host "  4. NuGet publish will trigger automatically"
          Write-Host "=================================================="

      # ── Upload artifacts ──────────────────────────────────
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            artifacts/*.nupkg
            artifacts/*.snupkg
            artifacts/*.zip
          retention-days: 90
