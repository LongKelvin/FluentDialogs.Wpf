<Window x:Class="FluentDialogs.Views.MessageBoxWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:FluentDialogs.Controls"
        xmlns:enums="clr-namespace:FluentDialogs.Enums"
        xmlns:viewmodels="clr-namespace:FluentDialogs.ViewModels"
        Title="{Binding Title}"
        Width="420"
        MinWidth="320"
        MaxWidth="560"
        SizeToContent="Height"
        WindowStartupLocation="CenterOwner"
        WindowStyle="None"
        AllowsTransparency="True"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        Background="Transparent">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/ThemeResources.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/FluentLight.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/ButtonStyles.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Controls/IconPresenter.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Visibility Converters -->
            <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
            
        </ResourceDictionary>
    </Window.Resources>

    <!-- Main Window Content with Shadow -->
    <Border Margin="16" 
            Background="{DynamicResource DialogBackgroundBrush}"
            BorderBrush="{DynamicResource DialogBorderBrush}"
            BorderThickness="1"
            CornerRadius="8">
        <Border.Effect>
            <DropShadowEffect BlurRadius="16" 
                              ShadowDepth="4" 
                              Direction="270" 
                              Opacity="0.3"
                              Color="{DynamicResource DialogShadowColor}"/>
        </Border.Effect>

        <Grid>
            <Grid.RowDefinitions>
                <!-- Title Bar -->
                <RowDefinition Height="Auto"/>
                <!-- Content Area -->
                <RowDefinition Height="*"/>
                <!-- Button Panel -->
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Title Bar -->
            <Grid Grid.Row="0" 
                  x:Name="TitleBar"
                  Height="40"
                  Background="Transparent"
                  MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title Text -->
                <TextBlock Grid.Column="0"
                           Text="{Binding Title}"
                           Foreground="{DynamicResource DialogForegroundBrush}"
                           FontSize="12"
                           FontFamily="Segoe UI"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           Margin="16,0,0,0"
                           TextTrimming="CharacterEllipsis"/>

                <!-- Close Button -->
                <Button Grid.Column="1"
                        x:Name="CloseButton"
                        Style="{StaticResource FluentCloseButtonStyle}"
                        Click="CloseButton_Click"
                        ToolTip="Close"/>
            </Grid>

            <!-- Content Area -->
            <Grid Grid.Row="1" Margin="24,8,24,24">
                <Grid.ColumnDefinitions>
                    <!-- Icon Column -->
                    <ColumnDefinition Width="Auto"/>
                    <!-- Content Column -->
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Icon -->
                <controls:IconPresenter Grid.Column="0"
                                        Icon="{Binding Icon}"
                                        Width="48"
                                        Height="48"
                                        Margin="0,0,16,0"
                                        VerticalAlignment="Top">
                    <controls:IconPresenter.Style>
                        <Style TargetType="{x:Type controls:IconPresenter}">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Icon}" Value="{x:Static enums:MessageBoxIcon.None}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </controls:IconPresenter.Style>
                </controls:IconPresenter>

                <!-- Text and Content Stack -->
                <StackPanel Grid.Column="1" VerticalAlignment="Top">
                    
                    <!-- Message Text -->
                    <TextBlock Text="{Binding Message}"
                               Foreground="{DynamicResource DialogForegroundBrush}"
                               FontSize="14"
                               FontFamily="Segoe UI"
                               TextWrapping="Wrap"
                               Margin="0,4,0,0"/>

                    <!-- Custom Content Area -->
                    <ContentControl Content="{Binding Content}"
                                    Margin="0,16,0,0"
                                    Visibility="{Binding HasContent, Converter={StaticResource BoolToVisConverter}}"/>

                    <!-- Exception Display Area -->
                    <Border Margin="0,16,0,0"
                            Padding="12"
                            Background="{DynamicResource ExceptionBackgroundBrush}"
                            BorderBrush="{DynamicResource ExceptionBorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Visibility="{Binding HasException, Converter={StaticResource BoolToVisConverter}}">
                        <StackPanel>
                            <!-- Exception Message -->
                            <TextBlock Text="{Binding ExceptionMessage}"
                                       Foreground="{DynamicResource ExceptionForegroundBrush}"
                                       FontSize="13"
                                       FontFamily="Segoe UI"
                                       TextWrapping="Wrap"/>

                            <!-- Show Details Toggle -->
                            <Button Content="{Binding StackTraceToggleText}"
                                    Command="{Binding ToggleStackTraceCommand}"
                                    Style="{StaticResource FluentHyperlinkStyle}"
                                    Margin="0,8,0,0"
                                    HorizontalAlignment="Left"/>

                            <!-- Stack Trace (Expandable) -->
                            <ScrollViewer MaxHeight="200"
                                          Margin="0,8,0,0"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Auto"
                                          Visibility="{Binding IsStackTraceVisible, Converter={StaticResource BoolToVisConverter}}">
                                <TextBlock Text="{Binding ExceptionStackTrace}"
                                           Foreground="{DynamicResource DialogSecondaryForegroundBrush}"
                                           FontSize="11"
                                           FontFamily="Consolas"
                                           TextWrapping="NoWrap"/>
                            </ScrollViewer>
                        </StackPanel>
                    </Border>

                </StackPanel>
            </Grid>

            <!-- Button Panel -->
            <Border Grid.Row="2"
                    Background="{DynamicResource DialogBackgroundBrush}"
                    BorderBrush="{DynamicResource DialogBorderBrush}"
                    BorderThickness="0,1,0,0"
                    Padding="24,16">
                
                <ItemsControl ItemsSource="{Binding Buttons}"
                              HorizontalAlignment="Right">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type viewmodels:MessageBoxButtonViewModel}">
                            <Button Content="{Binding Text}"
                                    Command="{Binding ClickCommand}"
                                    CommandParameter="{Binding}"
                                    IsDefault="{Binding IsDefault}"
                                    IsCancel="{Binding IsCancel}"
                                    Style="{StaticResource FluentMessageBoxButtonStyle}"
                                    Margin="8,0,0,0"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>

        </Grid>
    </Border>

</Window>
