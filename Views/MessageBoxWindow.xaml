<Window x:Class="FluentDialogs.Views.MessageBoxWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:FluentDialogs.Controls"
        xmlns:enums="clr-namespace:FluentDialogs.Enums"
        xmlns:viewmodels="clr-namespace:FluentDialogs.ViewModels"
        xmlns:converters="clr-namespace:FluentDialogs.Converters"
        Title="{Binding Title}"
        Width="{Binding DialogWidth, TargetNullValue=420}"
        Height="{Binding DialogHeight, TargetNullValue=NaN}"
        MinWidth="{Binding DialogMinWidth}"
        MinHeight="{Binding DialogMinHeight}"
        MaxWidth="{Binding DialogMaxWidth}"
        MaxHeight="{Binding DialogMaxHeight}"
        SizeToContent="{Binding DialogHeight, Converter={StaticResource SizeToContentConverter}, ConverterParameter=Height}"
        WindowStartupLocation="CenterOwner"
        WindowStyle="None"
        AllowsTransparency="True"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        Background="Transparent">

    <Window.Resources>
        <ResourceDictionary>
            <!--
                v2: NO theme dictionaries merged here.
                Theme resources come from App-level FluentDialogs.Theme.xaml.
                Only local resources that depend on ViewModel bindings live here.
            -->

            <!-- Custom Title Bar Brush (bound to ViewModel) -->
            <SolidColorBrush x:Key="CustomTitleBarBrush" Color="{Binding TitleBarColor, TargetNullValue={x:Static Colors.Transparent}}"/>
        </ResourceDictionary>
    </Window.Resources>

    <!-- Main Window Content with Shadow + Open Animation -->
    <Border x:Name="MainBorder"
            Margin="16"
            Background="{DynamicResource FDBrushSurfacePrimary}"
            BorderBrush="{DynamicResource FDBrushBorderDefault}"
            BorderThickness="1"
            CornerRadius="{DynamicResource FDRadiusMd}"
            RenderTransformOrigin="0.5,0.5">
        <Border.RenderTransform>
            <ScaleTransform x:Name="MainBorderScale" ScaleX="1" ScaleY="1"/>
        </Border.RenderTransform>
        <Border.Triggers>
            <EventTrigger RoutedEvent="Loaded">
                <BeginStoryboard>
                    <Storyboard>
                        <!-- Fade in -->
                        <DoubleAnimation Storyboard.TargetName="MainBorder"
                                         Storyboard.TargetProperty="Opacity"
                                         From="0" To="1"
                                         Duration="{StaticResource FDAnimDurationMedium}">
                            <DoubleAnimation.EasingFunction>
                                <CubicEase EasingMode="EaseOut"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                        <!-- Scale up -->
                        <DoubleAnimation Storyboard.TargetName="MainBorderScale"
                                         Storyboard.TargetProperty="ScaleX"
                                         From="0.96" To="1"
                                         Duration="{StaticResource FDAnimDurationMedium}">
                            <DoubleAnimation.EasingFunction>
                                <CubicEase EasingMode="EaseOut"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                        <DoubleAnimation Storyboard.TargetName="MainBorderScale"
                                         Storyboard.TargetProperty="ScaleY"
                                         From="0.96" To="1"
                                         Duration="{StaticResource FDAnimDurationMedium}">
                            <DoubleAnimation.EasingFunction>
                                <CubicEase EasingMode="EaseOut"/>
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </BeginStoryboard>
            </EventTrigger>
        </Border.Triggers>
        <Border.Style>
            <Style TargetType="Border">
                <Style.Triggers>
                    <!-- Error dialog gets red border accent -->
                    <DataTrigger Binding="{Binding IsErrorDialog}" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource FDBrushStatusError}"/>
                        <Setter Property="BorderThickness" Value="1,1,1,3"/>
                    </DataTrigger>
                    <!-- Warning dialog gets orange/yellow border accent -->
                    <DataTrigger Binding="{Binding IsWarningDialog}" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource FDBrushStatusWarning}"/>
                        <Setter Property="BorderThickness" Value="1,1,1,3"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        <Border.Effect>
            <DropShadowEffect BlurRadius="{DynamicResource FDElevationDialogBlur}"
                              ShadowDepth="{DynamicResource FDElevationDialogDepth}"
                              Direction="270"
                              Opacity="0.3"
                              Color="{DynamicResource FDSemShadow}"/>
        </Border.Effect>

        <Grid>
            <Grid.RowDefinitions>
                <!-- Title Bar -->
                <RowDefinition Height="Auto"/>
                <!-- Content Area -->
                <RowDefinition Height="*"/>
                <!-- Button Panel -->
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Title Bar -->
            <Border Grid.Row="0"
                    x:Name="TitleBar"
                    Height="{DynamicResource FDSizeTitleBarHeight}"
                    CornerRadius="{DynamicResource FDRadiusTitleBar}"
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="Transparent"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasCustomTitleBarColor}" Value="True">
                                <Setter Property="Background" Value="{StaticResource CustomTitleBarBrush}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Title Text -->
                    <TextBlock Grid.Column="0"
                               Text="{Binding Title}"
                               FontSize="{DynamicResource FDTypeSizeTitleBar}"
                               FontFamily="{DynamicResource FDTypeFontFamily}"
                               FontWeight="{DynamicResource FDTypeWeightSemiBold}"
                               VerticalAlignment="Center"
                               Margin="16,0,0,0"
                               TextTrimming="CharacterEllipsis">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource FDBrushOnSurfacePrimary}"/>
                                <Style.Triggers>
                                    <!-- Auto-adjust text color for custom title bar -->
                                    <DataTrigger Binding="{Binding HasCustomTitleBarColor}" Value="True">
                                        <Setter Property="Foreground" Value="{Binding TitleBarColor, Converter={StaticResource ColorContrastConverter}}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <!-- Close Button -->
                    <Button Grid.Column="1"
                            x:Name="CloseButton"
                            Click="CloseButton_Click"
                            ToolTip="Close">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource FDCloseButtonStyle}">
                                <Style.Triggers>
                                    <!-- Adjust close button for custom title bar -->
                                    <DataTrigger Binding="{Binding HasCustomTitleBarColor}" Value="True">
                                        <Setter Property="Foreground" Value="{Binding TitleBarColor, Converter={StaticResource ColorContrastConverter}}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>

            <!-- Content Area with Scrolling Support -->
            <ScrollViewer Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Margin="24,8,24,24">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <!-- Icon Column -->
                        <ColumnDefinition Width="Auto"/>
                        <!-- Content Column -->
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Icon - Always visible, defaults to Info style when None -->
                    <controls:IconPresenter Grid.Column="0"
                                            Icon="{Binding Icon}"
                                            Width="48"
                                            Height="48"
                                            Margin="0,0,16,0"
                                            VerticalAlignment="Top"/>

                    <!-- Text and Content Stack -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Top">

                        <!-- Message Text -->
                        <TextBlock Text="{Binding Message}"
                                   Foreground="{DynamicResource FDBrushOnSurfacePrimary}"
                                   FontSize="{DynamicResource FDTypeSizeMd}"
                                   FontFamily="{DynamicResource FDTypeFontFamily}"
                                   TextWrapping="Wrap"
                                   Margin="0,4,0,0"/>

                        <!-- Native Hyperlink -->
                        <TextBlock Margin="0,12,0,0"
                                   Visibility="{Binding HasHyperlink, Converter={StaticResource BoolToVisConverter}}">
                            <Hyperlink Command="{Binding OpenHyperlinkCommand}"
                                       Foreground="{DynamicResource FDBrushLinkDefault}">
                                <TextBlock Text="{Binding HyperlinkText}"/>
                            </Hyperlink>
                        </TextBlock>

                        <!-- Native Input Field -->
                        <Grid Margin="0,16,0,0"
                              Visibility="{Binding HasInput, Converter={StaticResource BoolToVisConverter}}">
                            <TextBox x:Name="InputTextBox"
                                     Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{DynamicResource FDTextBoxStyle}"
                                     Visibility="{Binding InputIsPassword, Converter={StaticResource InverseBoolToVisConverter}, ConverterParameter=Inverse}"/>
                            <PasswordBox x:Name="PasswordBox"
                                         Style="{DynamicResource FDPasswordBoxStyle}"
                                         Visibility="{Binding InputIsPassword, Converter={StaticResource BoolToVisConverter}}"/>
                            <!-- Placeholder text -->
                            <TextBlock Text="{Binding InputPlaceholder}"
                                       Style="{DynamicResource FDPlaceholderTextStyle}"
                                       Margin="10,8,0,0"
                                       Visibility="{Binding InputText, Converter={StaticResource EmptyStringToVisibilityConverter}}"/>
                        </Grid>

                        <!-- Native Selection List -->
                        <ListBox Margin="0,16,0,0"
                                 MaxHeight="200"
                                 ItemsSource="{Binding SelectionItems}"
                                 SelectedItem="{Binding SelectedItem}"
                                 SelectedIndex="{Binding SelectedIndex}"
                                 DisplayMemberPath="{Binding SelectionDisplayMemberPath}"
                                 Style="{DynamicResource FDListBoxStyle}"
                                 Visibility="{Binding HasSelection, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Native Dropdown (ComboBox) -->
                        <ComboBox Margin="0,16,0,0"
                                  ItemsSource="{Binding DropdownItems}"
                                  SelectedItem="{Binding DropdownSelectedItem}"
                                  SelectedIndex="{Binding DropdownSelectedIndex}"
                                  DisplayMemberPath="{Binding DropdownDisplayMemberPath}"
                                  Style="{DynamicResource FDComboBoxStyle}"
                                  Visibility="{Binding HasDropdown, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Detailed Text (License/Disclaimer) -->
                        <Border Margin="0,16,0,0"
                                Style="{DynamicResource FDDetailBorderStyle}"
                                Visibility="{Binding HasDetailedText, Converter={StaticResource BoolToVisConverter}}">
                            <ScrollViewer x:Name="DetailedTextScroller"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled"
                                          Padding="16">
                                <TextBlock Text="{Binding DetailedText}"
                                           Foreground="{DynamicResource FDBrushOnSurfacePrimary}"
                                           FontSize="{DynamicResource FDTypeSizeSm}"
                                           FontFamily="{DynamicResource FDTypeFontFamily}"
                                           LineHeight="{DynamicResource FDTypeLineHeightRelaxed}"
                                           TextWrapping="Wrap"/>
                            </ScrollViewer>
                        </Border>

                        <!-- Scroll requirement hint -->
                        <TextBlock Margin="0,8,0,0"
                                   Text="Please scroll to read the entire text above before accepting."
                                   Style="{DynamicResource FDHintTextStyle}"
                                   Visibility="{Binding RequireScrollToBottom, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Native Checkbox -->
                        <CheckBox Margin="0,16,0,0"
                                  Content="{Binding CheckboxText}"
                                  IsChecked="{Binding IsCheckboxChecked}"
                                  Foreground="{DynamicResource FDBrushOnSurfacePrimary}"
                                  Visibility="{Binding HasCheckbox, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Timeout Display -->
                        <TextBlock Margin="0,12,0,0"
                                   Text="{Binding TimeoutDisplayText}"
                                   Style="{DynamicResource FDHintTextStyle}"
                                   Visibility="{Binding HasTimeout, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Custom Content Area with theme-aware styling -->
                        <ContentControl Content="{Binding Content}"
                                        Margin="0,16,0,0"
                                        Visibility="{Binding HasContent, Converter={StaticResource BoolToVisConverter}}">
                            <ContentControl.Resources>
                                <!-- Apply theme colors to common controls in custom content -->
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{DynamicResource FDBrushOnSurfacePrimary}"/>
                                </Style>
                                <Style TargetType="CheckBox">
                                    <Setter Property="Foreground" Value="{DynamicResource FDBrushOnSurfacePrimary}"/>
                                </Style>
                                <Style TargetType="RadioButton">
                                    <Setter Property="Foreground" Value="{DynamicResource FDBrushOnSurfacePrimary}"/>
                                </Style>
                                <Style TargetType="Label">
                                    <Setter Property="Foreground" Value="{DynamicResource FDBrushOnSurfacePrimary}"/>
                                </Style>
                            </ContentControl.Resources>
                        </ContentControl>

                        <!-- Exception Display Area -->
                        <Border Margin="0,16,0,0"
                                Padding="12"
                                Background="{DynamicResource FDBrushStatusErrorSubtle}"
                                BorderBrush="{DynamicResource FDBrushOnStatusError}"
                                BorderThickness="1"
                                CornerRadius="{DynamicResource FDRadiusSm}"
                                Visibility="{Binding HasException, Converter={StaticResource BoolToVisConverter}}">
                            <StackPanel>
                                <!-- Exception Header with Copy Button -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Exception Message -->
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding ExceptionMessage}"
                                               Foreground="{DynamicResource FDBrushOnStatusError}"
                                               FontSize="{DynamicResource FDTypeSizeSm}"
                                               FontFamily="{DynamicResource FDTypeFontFamily}"
                                               TextWrapping="Wrap"
                                               VerticalAlignment="Center"/>

                                    <!-- Copy Exception Button -->
                                    <Button Grid.Column="1"
                                            Style="{StaticResource IconButtonStyle}"
                                            Command="{Binding CopyExceptionCommand}"
                                            ToolTip="Copy exception details"
                                            Margin="8,0,0,0">
                                        <Path Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                                              Fill="{DynamicResource FDBrushOnSurfaceSecondary}"
                                              Width="14" Height="14"
                                              Stretch="Uniform"/>
                                    </Button>
                                </Grid>

                                <!-- Show Details Toggle -->
                                <Button Content="{Binding StackTraceToggleText}"
                                        Command="{Binding ToggleStackTraceCommand}"
                                        Style="{StaticResource FluentHyperlinkStyle}"
                                        Margin="0,8,0,0"
                                        HorizontalAlignment="Left"/>

                                <!-- Stack Trace (Expandable) -->
                                <Border Margin="0,8,0,0"
                                        Background="{DynamicResource FDBrushSurfacePrimary}"
                                        BorderBrush="{DynamicResource FDBrushBorderDefault}"
                                        BorderThickness="1"
                                        CornerRadius="{DynamicResource FDRadiusSm}"
                                        Visibility="{Binding IsStackTraceVisible, Converter={StaticResource BoolToVisConverter}}">
                                    <ScrollViewer MaxHeight="250"
                                                  MinHeight="100"
                                                  Padding="8"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Auto">
                                        <TextBlock Text="{Binding ExceptionStackTrace}"
                                                   Foreground="{DynamicResource FDBrushOnSurfaceSecondary}"
                                                   FontSize="{DynamicResource FDTypeSizeXs}"
                                                   FontFamily="{DynamicResource FDTypeFontFamilyMono}"
                                                   TextWrapping="NoWrap"/>
                                    </ScrollViewer>
                                </Border>
                            </StackPanel>
                        </Border>

                    </StackPanel>
                </Grid>
            </ScrollViewer>

            <!-- Button Panel -->
            <Border Grid.Row="2"
                    Background="{DynamicResource FDBrushSurfacePrimary}"
                    BorderBrush="{DynamicResource FDBrushBorderDefault}"
                    BorderThickness="0,1,0,0"
                    CornerRadius="{DynamicResource FDRadiusButtonPanel}"
                    Padding="24,16">

                <ItemsControl ItemsSource="{Binding Buttons}"
                              HorizontalAlignment="Right">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type viewmodels:MessageBoxButtonViewModel}">
                            <Button Content="{Binding Text}"
                                    Command="{Binding ClickCommand}"
                                    CommandParameter="{Binding}"
                                    IsDefault="{Binding IsDefault}"
                                    IsCancel="{Binding IsCancel}"
                                    Style="{StaticResource FluentMessageBoxButtonStyle}"
                                    Margin="8,0,0,0"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>

        </Grid>
    </Border>

</Window>
