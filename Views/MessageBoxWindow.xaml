<Window x:Class="FluentDialogs.Views.MessageBoxWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:FluentDialogs.Controls"
        xmlns:enums="clr-namespace:FluentDialogs.Enums"
        xmlns:viewmodels="clr-namespace:FluentDialogs.ViewModels"
        Title="{Binding Title}"
        Width="420"
        MinWidth="320"
        MaxWidth="560"
        SizeToContent="Height"
        WindowStartupLocation="CenterOwner"
        WindowStyle="None"
        AllowsTransparency="True"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        Background="Transparent">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/ThemeResources.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/FluentLight.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/ButtonStyles.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Controls/IconPresenter.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Visibility Converters -->
            <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>

            <!-- Theme-aware styles for custom content -->
            <Style TargetType="TextBlock" x:Key="DialogTextBlockStyle">
                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                <Setter Property="FontFamily" Value="Segoe UI"/>
            </Style>
            
            <Style TargetType="CheckBox" x:Key="DialogCheckBoxStyle">
                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                <Setter Property="FontFamily" Value="Segoe UI"/>
            </Style>

            <Style TargetType="TextBox" x:Key="DialogTextBoxStyle">
                <Setter Property="Background" Value="{DynamicResource ButtonBackgroundBrush}"/>
                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                <Setter Property="BorderBrush" Value="{DynamicResource ButtonBorderBrush}"/>
                <Setter Property="FontFamily" Value="Segoe UI"/>
            </Style>

            <!-- Small icon button style for copy -->
            <Style x:Key="IconButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Padding" Value="4"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Width" Value="24"/>
                <Setter Property="Height" Value="24"/>
                <Setter Property="ToolTip" Value="Copy to clipboard"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}" 
                                    CornerRadius="4"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource ButtonHoverBackgroundBrush}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
            
        </ResourceDictionary>
    </Window.Resources>

    <!-- Main Window Content with Shadow -->
    <Border x:Name="MainBorder"
            Margin="16" 
            Background="{DynamicResource DialogBackgroundBrush}"
            BorderBrush="{DynamicResource DialogBorderBrush}"
            BorderThickness="1"
            CornerRadius="8">
        <Border.Style>
            <Style TargetType="Border">
                <Style.Triggers>
                    <!-- Error dialog gets red border accent -->
                    <DataTrigger Binding="{Binding IsErrorDialog}" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource ErrorDialogBorderBrush}"/>
                        <Setter Property="BorderThickness" Value="1,1,1,3"/>
                    </DataTrigger>
                    <!-- Warning dialog gets orange/yellow border accent -->
                    <DataTrigger Binding="{Binding IsWarningDialog}" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource WarningDialogBorderBrush}"/>
                        <Setter Property="BorderThickness" Value="1,1,1,3"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        <Border.Effect>
            <DropShadowEffect BlurRadius="16" 
                              ShadowDepth="4" 
                              Direction="270" 
                              Opacity="0.3"
                              Color="{DynamicResource DialogShadowColor}"/>
        </Border.Effect>

        <Grid>
            <Grid.RowDefinitions>
                <!-- Title Bar -->
                <RowDefinition Height="Auto"/>
                <!-- Content Area -->
                <RowDefinition Height="*"/>
                <!-- Button Panel -->
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Title Bar -->
            <Grid Grid.Row="0" 
                  x:Name="TitleBar"
                  Height="40"
                  Background="Transparent"
                  MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title Text -->
                <TextBlock Grid.Column="0"
                           Text="{Binding Title}"
                           Foreground="{DynamicResource DialogForegroundBrush}"
                           FontSize="12"
                           FontFamily="Segoe UI"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           Margin="16,0,0,0"
                           TextTrimming="CharacterEllipsis"/>

                <!-- Close Button -->
                <Button Grid.Column="1"
                        x:Name="CloseButton"
                        Style="{StaticResource FluentCloseButtonStyle}"
                        Click="CloseButton_Click"
                        ToolTip="Close"/>
            </Grid>

            <!-- Content Area -->
            <Grid Grid.Row="1" Margin="24,8,24,24">
                <Grid.ColumnDefinitions>
                    <!-- Icon Column -->
                    <ColumnDefinition Width="Auto"/>
                    <!-- Content Column -->
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Icon - Always visible, defaults to Info style when None -->
                <controls:IconPresenter Grid.Column="0"
                                        Icon="{Binding Icon}"
                                        Width="48"
                                        Height="48"
                                        Margin="0,0,16,0"
                                        VerticalAlignment="Top"/>

                <!-- Text and Content Stack -->
                <StackPanel Grid.Column="1" VerticalAlignment="Top">
                    
                    <!-- Message Text -->
                    <TextBlock Text="{Binding Message}"
                               Foreground="{DynamicResource DialogForegroundBrush}"
                               FontSize="14"
                               FontFamily="Segoe UI"
                               TextWrapping="Wrap"
                               Margin="0,4,0,0"/>

                    <!-- Custom Content Area with theme-aware styling -->
                    <ContentControl Content="{Binding Content}"
                                    Margin="0,16,0,0"
                                    Visibility="{Binding HasContent, Converter={StaticResource BoolToVisConverter}}">
                        <ContentControl.Resources>
                            <!-- Apply theme colors to common controls in custom content -->
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                            </Style>
                            <Style TargetType="CheckBox">
                                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                            </Style>
                            <Style TargetType="RadioButton">
                                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                            </Style>
                            <Style TargetType="Label">
                                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                            </Style>
                        </ContentControl.Resources>
                    </ContentControl>

                    <!-- Exception Display Area -->
                    <Border Margin="0,16,0,0"
                            Padding="12"
                            Background="{DynamicResource ExceptionBackgroundBrush}"
                            BorderBrush="{DynamicResource ExceptionBorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Visibility="{Binding HasException, Converter={StaticResource BoolToVisConverter}}">
                        <StackPanel>
                            <!-- Exception Header with Copy Button -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Exception Message -->
                                <TextBlock Grid.Column="0"
                                           Text="{Binding ExceptionMessage}"
                                           Foreground="{DynamicResource ExceptionForegroundBrush}"
                                           FontSize="13"
                                           FontFamily="Segoe UI"
                                           TextWrapping="Wrap"
                                           VerticalAlignment="Center"/>
                                
                                <!-- Copy Exception Button -->
                                <Button Grid.Column="1"
                                        Style="{StaticResource IconButtonStyle}"
                                        Command="{Binding CopyExceptionCommand}"
                                        ToolTip="Copy exception details"
                                        Margin="8,0,0,0">
                                    <Path Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                                          Fill="{DynamicResource DialogSecondaryForegroundBrush}"
                                          Width="14" Height="14"
                                          Stretch="Uniform"/>
                                </Button>
                            </Grid>

                            <!-- Show Details Toggle -->
                            <Button Content="{Binding StackTraceToggleText}"
                                    Command="{Binding ToggleStackTraceCommand}"
                                    Style="{StaticResource FluentHyperlinkStyle}"
                                    Margin="0,8,0,0"
                                    HorizontalAlignment="Left"/>

                            <!-- Stack Trace (Expandable) -->
                            <Border Margin="0,8,0,0"
                                    Background="{DynamicResource DialogBackgroundBrush}"
                                    BorderBrush="{DynamicResource DialogBorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Visibility="{Binding IsStackTraceVisible, Converter={StaticResource BoolToVisConverter}}">
                                <ScrollViewer MaxHeight="250"
                                              MinHeight="100"
                                              Padding="8"
                                              VerticalScrollBarVisibility="Auto"
                                              HorizontalScrollBarVisibility="Auto">
                                    <TextBlock Text="{Binding ExceptionStackTrace}"
                                               Foreground="{DynamicResource DialogSecondaryForegroundBrush}"
                                               FontSize="11"
                                               FontFamily="Cascadia Code, Consolas, Courier New"
                                               TextWrapping="NoWrap"/>
                                </ScrollViewer>
                            </Border>
                        </StackPanel>
                    </Border>

                </StackPanel>
            </Grid>

            <!-- Button Panel -->
            <Border Grid.Row="2"
                    Background="{DynamicResource DialogBackgroundBrush}"
                    BorderBrush="{DynamicResource DialogBorderBrush}"
                    BorderThickness="0,1,0,0"
                    Padding="24,16">
                
                <ItemsControl ItemsSource="{Binding Buttons}"
                              HorizontalAlignment="Right">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type viewmodels:MessageBoxButtonViewModel}">
                            <Button Content="{Binding Text}"
                                    Command="{Binding ClickCommand}"
                                    CommandParameter="{Binding}"
                                    IsDefault="{Binding IsDefault}"
                                    IsCancel="{Binding IsCancel}"
                                    Style="{StaticResource FluentMessageBoxButtonStyle}"
                                    Margin="8,0,0,0"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>

        </Grid>
    </Border>

</Window>
