<Window x:Class="FluentDialogs.Views.MessageBoxWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:FluentDialogs.Controls"
        xmlns:enums="clr-namespace:FluentDialogs.Enums"
        xmlns:viewmodels="clr-namespace:FluentDialogs.ViewModels"
        xmlns:converters="clr-namespace:FluentDialogs.Converters"
        Title="{Binding Title}"
        Width="{Binding DialogWidth, TargetNullValue=420}"
        Height="{Binding DialogHeight, TargetNullValue=NaN}"
        MinWidth="{Binding DialogMinWidth}"
        MinHeight="{Binding DialogMinHeight}"
        MaxWidth="{Binding DialogMaxWidth}"
        MaxHeight="{Binding DialogMaxHeight}"
        SizeToContent="{Binding DialogHeight, Converter={StaticResource SizeToContentConverter}, ConverterParameter=Height}"
        WindowStartupLocation="CenterOwner"
        WindowStyle="None"
        AllowsTransparency="True"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        Background="Transparent">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/ThemeResources.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/FluentLight.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Themes/ButtonStyles.xaml"/>
                <ResourceDictionary Source="/FluentDialogs.Wpf;component/Controls/IconPresenter.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Converters are now defined in ThemeResources.xaml -->

            <!-- Custom Title Bar Brush -->
            <SolidColorBrush x:Key="CustomTitleBarBrush" Color="{Binding TitleBarColor, TargetNullValue={x:Static Colors.Transparent}}"/>

            <!-- Improved Close Button Style -->
            <Style x:Key="ModernCloseButtonStyle" TargetType="Button">
                <Setter Property="Width" Value="46"/>
                <Setter Property="Height" Value="32"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="FontFamily" Value="Segoe UI Symbol"/>
                <Setter Property="FontSize" Value="10"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="border"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="0,8,0,0"
                                    SnapsToDevicePixels="True">
                                <TextBlock Text="&#xE106;"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           FontFamily="Segoe UI Symbol"
                                           FontSize="10"
                                           Foreground="{TemplateBinding Foreground}"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="#E81123"/>
                                    <Setter Property="Foreground" Value="White"/>
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="border" Property="Background" Value="#C50E1F"/>
                                    <Setter Property="Foreground" Value="White"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Theme-aware styles for custom content -->
            <Style TargetType="TextBlock" x:Key="DialogTextBlockStyle">
                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                <Setter Property="FontFamily" Value="Segoe UI"/>
            </Style>

            <Style TargetType="CheckBox" x:Key="DialogCheckBoxStyle">
                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                <Setter Property="FontFamily" Value="Segoe UI"/>
            </Style>

            <Style TargetType="TextBox" x:Key="DialogTextBoxStyle">
                <Setter Property="Background" Value="{DynamicResource ButtonBackgroundBrush}"/>
                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                <Setter Property="BorderBrush" Value="{DynamicResource ButtonBorderBrush}"/>
                <Setter Property="FontFamily" Value="Segoe UI"/>
            </Style>

            <!-- Small icon button style for copy -->
            <Style x:Key="IconButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Padding" Value="4"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Width" Value="24"/>
                <Setter Property="Height" Value="24"/>
                <Setter Property="ToolTip" Value="Copy to clipboard"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                                    CornerRadius="4"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource ButtonHoverBackgroundBrush}"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

        </ResourceDictionary>
    </Window.Resources>

    <!-- Main Window Content with Shadow -->
    <Border x:Name="MainBorder"
            Margin="16"
            Background="{DynamicResource DialogBackgroundBrush}"
            BorderBrush="{DynamicResource DialogBorderBrush}"
            BorderThickness="1"
            CornerRadius="8">
        <Border.Style>
            <Style TargetType="Border">
                <Style.Triggers>
                    <!-- Error dialog gets red border accent -->
                    <DataTrigger Binding="{Binding IsErrorDialog}" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource ErrorDialogBorderBrush}"/>
                        <Setter Property="BorderThickness" Value="1,1,1,3"/>
                    </DataTrigger>
                    <!-- Warning dialog gets orange/yellow border accent -->
                    <DataTrigger Binding="{Binding IsWarningDialog}" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource WarningDialogBorderBrush}"/>
                        <Setter Property="BorderThickness" Value="1,1,1,3"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        <Border.Effect>
            <DropShadowEffect BlurRadius="16"
                              ShadowDepth="4"
                              Direction="270"
                              Opacity="0.3"
                              Color="{DynamicResource DialogShadowColor}"/>
        </Border.Effect>

        <Grid>
            <Grid.RowDefinitions>
                <!-- Title Bar -->
                <RowDefinition Height="Auto"/>
                <!-- Content Area -->
                <RowDefinition Height="*"/>
                <!-- Button Panel -->
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Title Bar -->
            <Border Grid.Row="0"
                    x:Name="TitleBar"
                    Height="40"
                    CornerRadius="8,8,0,0"
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="Transparent"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasCustomTitleBarColor}" Value="True">
                                <Setter Property="Background" Value="{StaticResource CustomTitleBarBrush}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Title Text -->
                    <TextBlock Grid.Column="0"
                               Text="{Binding Title}"
                               FontSize="12"
                               FontFamily="Segoe UI"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               Margin="16,0,0,0"
                               TextTrimming="CharacterEllipsis">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                                <Style.Triggers>
                                    <!-- Auto-adjust text color for custom title bar -->
                                    <DataTrigger Binding="{Binding HasCustomTitleBarColor}" Value="True">
                                        <Setter Property="Foreground" Value="{Binding TitleBarColor, Converter={StaticResource ColorContrastConverter}}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <!-- Close Button -->
                    <Button Grid.Column="1"
                            x:Name="CloseButton"
                            Click="CloseButton_Click"
                            ToolTip="Close">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource ModernCloseButtonStyle}">
                                <Style.Triggers>
                                    <!-- Adjust close button for custom title bar -->
                                    <DataTrigger Binding="{Binding HasCustomTitleBarColor}" Value="True">
                                        <Setter Property="Foreground" Value="{Binding TitleBarColor, Converter={StaticResource ColorContrastConverter}}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>

            <!-- Content Area with Scrolling Support -->
            <ScrollViewer Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Margin="24,8,24,24">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <!-- Icon Column -->
                        <ColumnDefinition Width="Auto"/>
                        <!-- Content Column -->
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Icon - Always visible, defaults to Info style when None -->
                    <controls:IconPresenter Grid.Column="0"
                                            Icon="{Binding Icon}"
                                            Width="48"
                                            Height="48"
                                            Margin="0,0,16,0"
                                            VerticalAlignment="Top"/>

                    <!-- Text and Content Stack -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Top">

                        <!-- Message Text -->
                        <TextBlock Text="{Binding Message}"
                                   Foreground="{DynamicResource DialogForegroundBrush}"
                                   FontSize="14"
                                   FontFamily="Segoe UI"
                                   TextWrapping="Wrap"
                                   Margin="0,4,0,0"/>

                        <!-- Native Hyperlink -->
                        <TextBlock Margin="0,12,0,0"
                                   Visibility="{Binding HasHyperlink, Converter={StaticResource BoolToVisConverter}}">
                            <Hyperlink Command="{Binding OpenHyperlinkCommand}"
                                       Foreground="{DynamicResource HyperlinkBrush}">
                                <TextBlock Text="{Binding HyperlinkText}"/>
                            </Hyperlink>
                        </TextBlock>

                        <!-- Native Input Field -->
                        <Grid Margin="0,16,0,0"
                              Visibility="{Binding HasInput, Converter={StaticResource BoolToVisConverter}}">
                            <TextBox x:Name="InputTextBox"
                                     Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                                     Padding="8,6"
                                     FontSize="14"
                                     Background="{DynamicResource ButtonBackgroundBrush}"
                                     Foreground="{DynamicResource DialogForegroundBrush}"
                                     BorderBrush="{DynamicResource ButtonBorderBrush}"
                                     BorderThickness="1"
                                     Visibility="{Binding InputIsPassword, Converter={StaticResource InverseBoolToVisConverter}, ConverterParameter=Inverse}"/>
                            <PasswordBox x:Name="PasswordBox"
                                         Padding="8,6"
                                         FontSize="14"
                                         Background="{DynamicResource ButtonBackgroundBrush}"
                                         Foreground="{DynamicResource DialogForegroundBrush}"
                                         BorderBrush="{DynamicResource ButtonBorderBrush}"
                                         BorderThickness="1"
                                         Visibility="{Binding InputIsPassword, Converter={StaticResource BoolToVisConverter}}"/>
                            <!-- Placeholder text -->
                            <TextBlock Text="{Binding InputPlaceholder}"
                                       Foreground="{DynamicResource DialogSecondaryForegroundBrush}"
                                       FontSize="14"
                                       Margin="10,8,0,0"
                                       IsHitTestVisible="False"
                                       Visibility="{Binding InputText, Converter={StaticResource EmptyStringToVisibilityConverter}}"/>
                        </Grid>

                        <!-- Native Selection List -->
                        <ListBox Margin="0,16,0,0"
                                 MaxHeight="200"
                                 ItemsSource="{Binding SelectionItems}"
                                 SelectedItem="{Binding SelectedItem}"
                                 SelectedIndex="{Binding SelectedIndex}"
                                 DisplayMemberPath="{Binding SelectionDisplayMemberPath}"
                                 Background="{DynamicResource ButtonBackgroundBrush}"
                                 Foreground="{DynamicResource DialogForegroundBrush}"
                                 BorderBrush="{DynamicResource ButtonBorderBrush}"
                                 Visibility="{Binding HasSelection, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Detailed Text (License/Disclaimer) -->
                        <Border Margin="0,16,0,0"
                                MinHeight="150"
                                MaxHeight="300"
                                Background="{DynamicResource ButtonBackgroundBrush}"
                                BorderBrush="{DynamicResource ButtonBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="6"
                                Visibility="{Binding HasDetailedText, Converter={StaticResource BoolToVisConverter}}">
                            <ScrollViewer x:Name="DetailedTextScroller"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled"
                                          Padding="16">
                                <TextBlock Text="{Binding DetailedText}"
                                           Foreground="{DynamicResource DialogForegroundBrush}"
                                           FontSize="13"
                                           FontFamily="Segoe UI"
                                           LineHeight="20"
                                           TextWrapping="Wrap"/>
                            </ScrollViewer>
                        </Border>

                        <!-- Scroll requirement hint -->
                        <TextBlock Margin="0,8,0,0"
                                   Text="Please scroll to read the entire text above before accepting."
                                   Foreground="{DynamicResource DialogSecondaryForegroundBrush}"
                                   FontSize="11"
                                   FontStyle="Italic"
                                   Visibility="{Binding RequireScrollToBottom, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Native Checkbox -->
                        <CheckBox Margin="0,16,0,0"
                                  Content="{Binding CheckboxText}"
                                  IsChecked="{Binding IsCheckboxChecked}"
                                  Foreground="{DynamicResource DialogForegroundBrush}"
                                  Visibility="{Binding HasCheckbox, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Timeout Display -->
                        <TextBlock Margin="0,12,0,0"
                                   Text="{Binding TimeoutDisplayText}"
                                   Foreground="{DynamicResource DialogSecondaryForegroundBrush}"
                                   FontSize="12"
                                   FontStyle="Italic"
                                   Visibility="{Binding HasTimeout, Converter={StaticResource BoolToVisConverter}}"/>

                        <!-- Custom Content Area with theme-aware styling -->
                        <ContentControl Content="{Binding Content}"
                                        Margin="0,16,0,0"
                                        Visibility="{Binding HasContent, Converter={StaticResource BoolToVisConverter}}">
                            <ContentControl.Resources>
                                <!-- Apply theme colors to common controls in custom content -->
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                                </Style>
                                <Style TargetType="CheckBox">
                                    <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                                </Style>
                                <Style TargetType="RadioButton">
                                    <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                                </Style>
                                <Style TargetType="Label">
                                    <Setter Property="Foreground" Value="{DynamicResource DialogForegroundBrush}"/>
                                </Style>
                            </ContentControl.Resources>
                        </ContentControl>

                        <!-- Exception Display Area -->
                        <Border Margin="0,16,0,0"
                                Padding="12"
                                Background="{DynamicResource ExceptionBackgroundBrush}"
                                BorderBrush="{DynamicResource ExceptionBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Visibility="{Binding HasException, Converter={StaticResource BoolToVisConverter}}">
                            <StackPanel>
                                <!-- Exception Header with Copy Button -->
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Exception Message -->
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding ExceptionMessage}"
                                               Foreground="{DynamicResource ExceptionForegroundBrush}"
                                               FontSize="13"
                                               FontFamily="Segoe UI"
                                               TextWrapping="Wrap"
                                               VerticalAlignment="Center"/>

                                    <!-- Copy Exception Button -->
                                    <Button Grid.Column="1"
                                            Style="{StaticResource IconButtonStyle}"
                                            Command="{Binding CopyExceptionCommand}"
                                            ToolTip="Copy exception details"
                                            Margin="8,0,0,0">
                                        <Path Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                                              Fill="{DynamicResource DialogSecondaryForegroundBrush}"
                                              Width="14" Height="14"
                                              Stretch="Uniform"/>
                                    </Button>
                                </Grid>

                                <!-- Show Details Toggle -->
                                <Button Content="{Binding StackTraceToggleText}"
                                        Command="{Binding ToggleStackTraceCommand}"
                                        Style="{StaticResource FluentHyperlinkStyle}"
                                        Margin="0,8,0,0"
                                        HorizontalAlignment="Left"/>

                                <!-- Stack Trace (Expandable) -->
                                <Border Margin="0,8,0,0"
                                        Background="{DynamicResource DialogBackgroundBrush}"
                                        BorderBrush="{DynamicResource DialogBorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="4"
                                        Visibility="{Binding IsStackTraceVisible, Converter={StaticResource BoolToVisConverter}}">
                                    <ScrollViewer MaxHeight="250"
                                                  MinHeight="100"
                                                  Padding="8"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Auto">
                                        <TextBlock Text="{Binding ExceptionStackTrace}"
                                                   Foreground="{DynamicResource DialogSecondaryForegroundBrush}"
                                                   FontSize="11"
                                                   FontFamily="Cascadia Code, Consolas, Courier New"
                                                   TextWrapping="NoWrap"/>
                                    </ScrollViewer>
                                </Border>
                            </StackPanel>
                        </Border>

                    </StackPanel>
                </Grid>
            </ScrollViewer>

            <!-- Button Panel -->
            <Border Grid.Row="2"
                    Background="{DynamicResource DialogBackgroundBrush}"
                    BorderBrush="{DynamicResource DialogBorderBrush}"
                    BorderThickness="0,1,0,0"
                    Padding="24,16">

                <ItemsControl ItemsSource="{Binding Buttons}"
                              HorizontalAlignment="Right">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type viewmodels:MessageBoxButtonViewModel}">
                            <Button Content="{Binding Text}"
                                    Command="{Binding ClickCommand}"
                                    CommandParameter="{Binding}"
                                    IsDefault="{Binding IsDefault}"
                                    IsCancel="{Binding IsCancel}"
                                    Style="{StaticResource FluentMessageBoxButtonStyle}"
                                    Margin="8,0,0,0"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>

        </Grid>
    </Border>

</Window>
